---
title: "テスト"
---

Perlは実行しないとわからない動的型付け言語です。そのため、ユニットテストをとても大切にしており、充実したテストフレームワークと実践的なテスト文化があります。この章では、モダンなPerlにおけるテストの書き方を解説します。

## Test2::V0を使ったユニットテスト

Test2::V0は、Perlの最新テストフレームワークです。古いTest::Moreの後継として、より強力で使いやすいAPIを提供します。

### 基本的なテストの書き方

```perl
use v5.42;
use Test2::V0;

# 値の比較
is 1 + 1, 2, '1 + 1 equals 2';

# 真偽値のテスト
ok 1, 'true value';
ok !0, 'false value';

# 配列の比較
is [1, 2, 3], [1, 2, 3], 'array comparison';

# ハッシュの比較
is { foo => 1, bar => 2 }, { foo => 1, bar => 2 }, 'hash comparison';

# 例外のテスト
like(
    dies { die "error message" },
    qr/error message/,
    'dies with expected message'
);

# テストの終了を明示
done_testing;
```

### テーブルテストで効率的にテストを書く

同じ処理を異なる入力と期待値でテストする場合、forループと複数の変数受け取りを活用したテーブルテストが便利です。

```perl
use v5.42;
use Test2::V0;

sub add($x, $y) { $x + $y }

# テーブル形式でテストケースを定義
my @cases = (
    ['adds positive numbers',    [1, 2],     3],
    ['adds negative numbers',    [-1, -2],  -3],
    ['adds zero',                [5, 0],     5],
    ['adds large numbers',       [100, 200], 300],
);

for my ($message, $args, $expected) (@cases) {
    is add($args->@*), $expected, $message;
}

done_testing;
```

このようにテーブルテストを使うことで、テストケースの追加が容易になり、テストの見通しも良くなります。

### レキシカル関数でテストを整理する

`my sub`でレキシカル関数を定義することで、テストのユーティリティ関数を小さな範囲で共通化し、テストの見通しを良くすることができます。

```perl
use v5.42;
use Test2::V0;

package Calculator {
    sub add($x, $y) { $x + $y }
    sub subtract($x, $y) { $x - $y }
    sub multiply($x, $y) { $x * $y }
}

subtest 'addition' => sub {
    # このsubtestでのみ有効なユーティリティ関数
    my sub subject($x, $y) { Calculator::add($x, $y) }

    is subject(1, 2), 3;
    is subject(5, 5), 10;
    is subject(-1, 1), 0;
};

subtest 'subtraction' => sub {
    my sub subject($x, $y) { Calculator::subtract($x, $y) }

    is subject(5, 3), 2;
    is subject(10, 5), 5;
    is subject(0, 1), -1;
};

done_testing;
```

レキシカル関数を使うことで、各subtestが独立し、名前の衝突を気にせずにユーティリティ関数を定義できます。

## Test2::Pluginで便利な機能を追加する

Test2::Pluginを使うことで、テストの挙動をカスタマイズできます。

### 警告をエラーとして扱う

テストコード内で警告が出たらテストを失敗させることができます。

```perl
use v5.42;
use Test2::V0;
use Test2::Plugin::NoWarnings;

# 警告が出るとテストが失敗する
my $x;
# say $x;  # これを実行すると "Use of uninitialized value" 警告でテストが失敗

is 1 + 1, 2, 'basic test';

done_testing;
```

### UTF-8の取り扱い

日本語を含むテストを書く場合、UTF-8を有効にします。

```perl
use v5.42;
use Test2::V0;
use utf8;

# 日本語のテスト
is length("あいう"), 3, '日本語の文字数';
is "Hello, 世界" =~ s/世界/World/r, "Hello, World", '日本語の置換';

# 日本語のメッセージ
ok 1, '日本語でテストメッセージを書ける';

done_testing;
```

## T2_RAND_SEED環境変数

Test2は、テストの実行順序やランダムな振る舞いを再現可能にするため、`T2_RAND_SEED`環境変数をサポートしています。

```perl
use v5.42;
use Test2::V0;

# テストで乱数を使う場合
sub generate_random_id() {
    return int(rand(1000000));
}

my $id1 = generate_random_id();
my $id2 = generate_random_id();

isnt $id1, $id2, 'different random IDs';

done_testing;
```

同じシード値でテストを実行することで、同じ結果を得られます：

```bash
# 最初の実行
T2_RAND_SEED=42 perl test.t

# 同じ結果を再現
T2_RAND_SEED=42 perl test.t
```

## モックとスパイ

外部の依存関係をテストする際、モックやスパイを使って依存関係を置き換えることができます。

### モックで外部依存を置き換える

```perl
use v5.42;
use Test2::V0;

package WeatherAPI {
    sub get_temperature($city) {
        # 実際には外部APIを叩いて気温を返す
        die "Network error: cannot connect to weather API";
    }
}

sub format_weather($city) {
    sprintf("現在の%sの気温は%s度です", $city, WeatherAPI::get_temperature($city))
}

subtest 'with mocked API' => sub {
    # モックを作成してAPIの振る舞いを置き換える
    my $mock = mock 'WeatherAPI' => (
        override => [
            get_temperature => sub($city) {
                return 25 if $city eq 'Tokyo';
                return 15 if $city eq 'London';
                return 30; # その他の都市
            }
        ]
    );

    is format_weather('Tokyo'), '現在のTokyoの気温は25度です';
    is format_weather('London'), '現在のLondonの気温は15度です';
    is format_weather('Paris'), '現在のParisの気温は30度です';
};

# モックのスコープを抜けると元の実装に戻る

done_testing;
```

### スパイで呼び出しを記録する

```perl
use v5.42;
use Test2::V0;

package Logger {
    sub log($message) {
        # 実際にはログファイルに書き込む
    }
}

package UserService {
    sub create_user($name) {
        Logger::log("Creating user: $name");
        return { id => 1, name => $name };
    }
}

subtest 'spy on logger' => sub {
    my @calls;
    my $mock = mock 'Logger' => (
        override => [
            log => sub($message) {
                push @calls, $message;
            }
        ]
    );

    UserService::create_user('Alice');
    UserService::create_user('Bob');

    # ログが呼ばれたことを確認
    is scalar(@calls), 2, 'log was called twice';
    is $calls[0], 'Creating user: Alice', 'first log message';
    is $calls[1], 'Creating user: Bob', 'second log message';
};

done_testing;
```

### 部分的なモック

特定のメソッドだけをモックし、他のメソッドは元の実装を使うこともできます。

```perl
use v5.42;
use Test2::V0;

package Database {
    sub connect($dsn) {
        # 実際のDB接続
        die "Cannot connect to database";
    }

    sub query($sql) {
        # SQLクエリを実行
        return [];
    }
}

subtest 'partial mock' => sub {
    my $mock = mock 'Database' => (
        override => [
            # connectだけモックし、queryは元の実装を使う
            connect => sub($dsn) {
                return { connected => 1 };
            }
        ]
    );

    # connectは成功する
    my $conn = Database::connect('dbi:SQLite:test.db');
    ok $conn->{connected}, 'connection succeeded';
};

done_testing;
```

## GitHub ActionsでCIを設定する

Perlのテストを継続的に実行するため、GitHub Actionsを設定します。

### 基本的なワークフロー

`.github/workflows/test.yml`を作成します：

```yaml
name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        perl-version:
          - '5.42'
          - '5.40'
          - '5.38'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Perl
      uses: shogo82148/actions-setup-perl@v1
      with:
        perl-version: ${{ matrix.perl-version }}
    
    - name: Install dependencies
      run: |
        cpanm --notest --installdeps .
    
    - name: Run tests
      run: |
        prove -lr t/
```

### 複数のPerlバージョンでテストする

上記の設定では、`strategy.matrix`を使って複数のPerlバージョンでテストを実行します。これにより、異なるバージョンでの互換性を確認できます。

### カバレッジの計測

Devel::CoverとCoverallsを使ってカバレッジを計測できます：

```yaml
- name: Install Devel::Cover
  run: cpanm --notest Devel::Cover::Report::Coveralls

- name: Run tests with coverage
  run: |
    cover -test -report coveralls
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## ベストプラクティス

### 1. テストファイルの配置

テストファイルは`t/`ディレクトリに配置します：

```
project/
├── lib/
│   └── MyApp/
│       └── Calculator.pm
├── t/
│   ├── 00-load.t
│   ├── 01-basic.t
│   ├── 02-calculator.t
│   └── lib/
│       └── TestHelper.pm
└── cpanfile
```

### 2. テストの実行

```bash
# 全テストを実行
prove -lr t/

# 特定のテストファイルを実行
perl t/01-basic.t

# 詳細な出力で実行
prove -lrv t/

# 並列実行
prove -lr -j4 t/
```

### 3. テストの整理

関連するテストは`subtest`でグループ化します：

```perl
use v5.42;
use Test2::V0;

subtest 'User creation' => sub {
    # ユーザー作成に関するテスト
};

subtest 'User validation' => sub {
    # ユーザーバリデーションに関するテスト
};

subtest 'User deletion' => sub {
    # ユーザー削除に関するテスト
};

done_testing;
```

### 4. テストデータの準備

共通のテストデータは、ヘルパー関数やフィクスチャとして用意します：

```perl
use v5.42;
use Test2::V0;

my sub create_test_user($name = 'Test User') {
    return {
        id => 1,
        name => $name,
        email => lc($name) =~ s/ /_/gr . '@example.com',
    };
}

subtest 'user tests' => sub {
    my $user = create_test_user('Alice');
    is $user->{name}, 'Alice';
    is $user->{email}, 'alice@example.com';
};

done_testing;
```

### 5. エラーメッセージの明確化

テストが失敗した時に何が問題かわかりやすいメッセージを付けます：

```perl
use v5.42;
use Test2::V0;

my $result = calculate_total([10, 20, 30]);

is $result, 60, 'calculate_total sums array elements correctly';

# 悪い例：メッセージなし
is $result, 60;

done_testing;
```

## まとめ

- Test2::V0は、Perlのモダンなテストフレームワークです
- テーブルテストとレキシカル関数を使うことで、テストを整理しやすくなります
- Test2::Pluginで警告やUTF-8の扱いをカスタマイズできます
- T2_RAND_SEED環境変数でランダムな振る舞いを再現できます
- mockとspyで外部依存をテストできます
- GitHub Actionsで継続的にテストを実行できます

Perlは動的型付け言語であるため、テストが品質を保つ重要な役割を果たします。充実したテストを書いて、安心してコードを変更できるようにしましょう。

## SEE ALSO

- [Test2::V0](https://metacpan.org/pod/Test2::V0) - Test2フレームワークのモダンなインターフェース
- [Test2::Suite](https://metacpan.org/pod/Test2::Suite) - Test2のツール集
- [Test2::Plugin::NoWarnings](https://metacpan.org/pod/Test2::Plugin::NoWarnings) - 警告をエラーとして扱うプラグイン
- [Test2::Manual](https://metacpan.org/pod/Test2::Manual) - Test2の詳細なマニュアル
- [Perl Testing: A Developer's Notebook](https://www.oreilly.com/library/view/perl-testing-a/0596100922/) - Perlのテストに関する書籍
