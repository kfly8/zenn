---
title: "正規表現"
---

正規表現（Regular Expression）は、文字列のパターンマッチングや置換を行うための強力な機能です。Perlは正規表現のサポートが非常に充実しており、多くのプログラミング言語の正規表現実装に影響を与えてきました。

## マッチオペレーター（m//）

`m//`演算子は、文字列が正規表現パターンにマッチするかを判定します。`m`を省略して`//`だけでも書けます。

```perl
use v5.42;

my $text = "Hello, Perl!";

# m// を使った基本的なマッチング
if ($text =~ m/Perl/) {
    say "Perlが見つかりました";
}

# m を省略した形式
if ($text =~ /Perl/) {
    say "Perlが見つかりました";
}

# マッチしない場合
if ($text !~ /Ruby/) {
    say "Rubyは見つかりませんでした";
}
```

### キャプチャグループ

括弧`()`でパターンを囲むと、マッチした部分を変数に保存できます。`$1`、`$2`、`$3`...という特殊変数に順番に格納されます。

```perl
use v5.42;

my $date = "2024-12-31";

if ($date =~ /(\d{4})-(\d{2})-(\d{2})/) {
    my $year  = $1;  # "2024"
    my $month = $2;  # "12"
    my $day   = $3;  # "31"
    
    say "年: $year, 月: $month, 日: $day";
}
```

注意：`$1`、`$2`などの変数は、マッチが成功した後でのみ有効です。マッチが失敗すると、これらの変数は以前の値を保持します。

### 名前付きキャプチャ

`(?<name>pattern)`の形式で、キャプチャグループに名前を付けることができます。名前付きキャプチャは`%+`ハッシュからアクセスできます。

```perl
use v5.42;

my $date = "2024-12-31";

if ($date =~ /(?<year>\d{4})-(?<month>\d{2})-(?<day>\d{2})/) {
    say "年: $+{year}";   # "2024"
    say "月: $+{month}";  # "12"
    say "日: $+{day}";    # "31"
}

# 複雑な例：ログのパース
my $log = "[2024-12-31 15:30:45] ERROR: Connection failed";

if ($log =~ /\[(?<date>[\d-]+) (?<time>[\d:]+)\] (?<level>\w+): (?<message>.+)/) {
    say "日付: $+{date}";
    say "時刻: $+{time}";
    say "レベル: $+{level}";
    say "メッセージ: $+{message}";
}
```

名前付きキャプチャを使うことで、正規表現の意図が明確になります。

### xxオプション - 正規表現内でのコメント利用

`x`修飾子を使うと、正規表現内の空白文字が無視され、コメント（`#`以降）も書けるようになります。複雑な正規表現を読みやすくするのに便利です。

Perl v5.26以降では、`xx`修飾子も利用できます。`xx`修飾子は`x`修飾子とほぼ同じですが、ブラケット文字クラス内（`[]`の中）でも、バックスラッシュでエスケープされていないスペースやタブが無視されるようになります。これにより、文字クラスもより読みやすく書くことができます。

```perl
use v5.42;

my $phone = "03-1234-5678";

# x修飾子なし（読みにくい）
if ($phone =~ /^(\d{2,4})-(\d{2,4})-(\d{4})$/) {
    say "電話番号が有効です";
}

# x修飾子あり（読みやすい）
if ($phone =~ /
    ^               # 行の先頭
    (\d{2,4})       # 市外局番（2〜4桁）
    -               # ハイフン
    (\d{2,4})       # 市内局番（2〜4桁）
    -               # ハイフン
    (\d{4})         # 加入者番号（4桁）
    $               # 行の末尾
/x) {
    say "電話番号が有効です";
}
```

`x`修飾子や`xx`修飾子を使用する場合、実際の空白文字をマッチさせたいときは、`\ `（バックスラッシュ+スペース）または`\s`を使用します。

### その他の便利な修飾子

```perl
use v5.42;

my $text = "Perl is GREAT";

# i修飾子：大文字小文字を区別しない
if ($text =~ /perl/i) {
    say "マッチしました（大文字小文字を無視）";
}

# g修飾子：グローバルマッチ（すべてのマッチを見つける）
my @words = $text =~ /\b\w+\b/g;
say "単語一覧: @words";  # Perl is GREAT

# s修飾子：.（ドット）が改行にもマッチするようにする
my $multiline = "First line\nSecond line";
if ($multiline =~ /First.*Second/s) {
    say "複数行にまたがってマッチしました";
}

# 修飾子の組み合わせ
my $code = "PRINT 'hello';";
if ($code =~ /
    print       # print文
    \s+         # 空白
    '(.+)'      # 文字列リテラル
/ix) {
    say "マッチした文字列: $1";
}
```

## 正規表現リファレンス（qr//）

`qr//`演算子を使うと、正規表現をリファレンス（スカラー値）として扱えます。これにより、正規表現を変数に代入したり、関数の引数として渡したりできます。

```perl
use v5.42;

# 正規表現を変数に保存
my $number_pattern = qr/\d+/;
my $email_pattern  = qr/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;

if ("The price is 100 yen" =~ $number_pattern) {
    say "数字が見つかりました: $&";
}

if ("contact@example.com" =~ $email_pattern) {
    say "メールアドレスが見つかりました";
}

# 正規表現の合成
my $protocol = qr/https?/;
my $domain   = qr/[a-z0-9.-]+/;
my $url      = qr/$protocol:\/\/$domain/;

if ("https://example.com" =~ $url) {
    say "有効なURLです";
}

# 配列やハッシュに正規表現を格納
my @patterns = (
    qr/perl/i,
    qr/python/i,
    qr/ruby/i,
);

my $text = "I love Perl programming";
for my $pattern (@patterns) {
    if ($text =~ $pattern) {
        say "マッチしました: $pattern";
    }
}
```

正規表現リファレンスは、動的にパターンを組み立てたり、設定ファイルから読み込んだパターンを使う場合に特に便利です。

## 置換オペレーター（s///）

`s///`演算子は、文字列内のパターンを別の文字列に置換します。

```perl
use v5.42;

my $text = "Hello, World!";

# 基本的な置換
$text =~ s/World/Perl/;
say $text;  # "Hello, Perl!"

# 複数回の置換（g修飾子）
my $sentence = "cat cat cat";
$sentence =~ s/cat/dog/g;
say $sentence;  # "dog dog dog"

# キャプチャグループを使った置換
my $date = "2024/12/31";
$date =~ s|(\d{4})/(\d{2})/(\d{2})|$1-$2-$3|;
say $date;  # "2024-12-31"

# 名前付きキャプチャを使った置換
my $log = "ERROR: connection failed";
$log =~ s/(?<level>\w+): (?<msg>.+)/[$+{level}] $+{msg}/;
say $log;  # "[ERROR] connection failed"
```

### rオプション - 非破壊的置換

`r`修飾子を使うと、元の変数を変更せず、置換後の新しい文字列を返します。

```perl
use v5.42;

my $original = "Hello, World!";

# r修飾子なし：元の変数が変更される
my $text1 = $original;
$text1 =~ s/World/Perl/;
say $text1;      # "Hello, Perl!"
say $original;   # "Hello, World!" （元の値は保持）

# r修飾子あり：元の変数は変更されず、新しい文字列が返される
my $text2 = $original =~ s/World/Ruby/r;
say $text2;      # "Hello, Ruby!"
say $original;   # "Hello, World!" （変更されていない）

# 複数の置換を連鎖させる
my $result = "aaa bbb ccc"
    =~ s/aaa/AAA/r
    =~ s/bbb/BBB/r
    =~ s/ccc/CCC/r;
say $result;     # "AAA BBB CCC"
```

`r`修飾子は、関数型プログラミングのスタイルでコードを書く場合や、元の値を保持したい場合に便利です。

### その他の置換例

```perl
use v5.42;

# 置換時に式を評価する（e修飾子）
my $text = "The price is 100 yen";
$text =~ s/(\d+)/$1 * 1.1/e;  # 10%増
say $text;  # "The price is 110 yen"

# 複数の置換を同時に行う（g修飾子）
my $code = "PRINT hello PRINT world";
$code =~ s/PRINT/say/gi;
say $code;  # "say hello say world"

# 削除（空文字列に置換）
my $phone = "03-1234-5678";
$phone =~ s/-//g;
say $phone;  # "0312345678"

# 正規表現リファレンスを使った置換
my $pattern = qr/\d+/;
my $price = "Price: 1000 yen";
$price =~ s/$pattern/2000/;
say $price;  # "Price: 2000 yen"
```

## 実践例

### URLからクエリパラメータを抽出

```perl
use v5.42;

my $url = "https://example.com/search?q=perl&lang=ja&page=1";

if ($url =~ /\?(?<params>.+)/) {
    my $query_string = $+{params};
    my %params;
    
    while ($query_string =~ /(?<key>[^=&]+)=(?<value>[^&]+)/g) {
        $params{$+{key}} = $+{value};
    }
    
    say "検索クエリ: $params{q}";      # perl
    say "言語: $params{lang}";          # ja
    say "ページ: $params{page}";       # 1
}
```

### HTMLタグの除去

```perl
use v5.42;

my $html = '<p>This is <strong>bold</strong> text.</p>';
my $plain = $html =~ s/<[^>]+>//gr;
say $plain;  # "This is bold text."
```

### パスワードのマスキング

```perl
use v5.42;

my $log = "User: admin, Password: secret123, Status: OK";
my $masked = $log =~ s/(Password: )\w+/$1****/r;
say $masked;  # "User: admin, Password: ****, Status: OK"
```

## SEE ALSO

- [perldoc.jp/perlre](https://perldoc.jp/docs/perl/5.42.0/perlre.pod) - Perl正規表現の詳細なドキュメント
- [perldoc.jp/perlop](https://perldoc.jp/docs/perl/5.42.0/perlop.pod) - マッチと置換オペレーター
- [perldoc.jp/perlretut](https://perldoc.jp/docs/perl/5.42.0/perlretut.pod) - 正規表現チュートリアル
