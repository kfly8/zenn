---
title: "日本語や絵文字などのマルチバイト文字を扱う作法"
---

`use v5.42`といつものおまじないを書いて、日本語や絵文字などのマルチバイト文字をソースコードに含めた場合、「Use of non-ASCII character」というエラーになります。これは`v5.41`以降に導入された[source::encoding](https://metacpan.org/pod/source::encoding)プラグマの影響で、意図しないエンコーディングの混在、いわゆる文字化けを防ぐためのものです。

```perl
use v5.42;

my ($message) = @ARGV;
$message //= 'Hello, 世界!'; # => Use of non-ASCII character 0xE4 illegal when 'use source::encoding "ascii"' is in effect

say $message;
```

こういったマルチバイト文字を扱う時の作法は次の通りです。

1. バイト列の入力をdecodeしてテキスト文字列にする
2. テキスト文字列をencodeしてバイト列を出力する

実際にこの作法をコードに反映すると次のように書けます。ここではこのコードを詳しく解説します。

```perl
use v5.42;
use utf8;  # テキスト文字列はUTF-8にすると宣言
use Encode qw(encode_utf8 decode_utf8);

my ($message) = map{ decode_utf8($_) } @ARGV;  # 1. 入力をdecode
$message //= 'Hello, 世界!';

say encode_utf8($message);  # 2. 出力をencode
```

## 用語の整理

### バイト列（Byte String）

バイト列とは、文字を特定の規則に従って整数値に変換したものです。この特定の規則を、文字エンコーディングと呼び、ASCII、UTF-8、Shift-JISなど様々あります。
アルファベットの「a」を、ASCII、UTF-8、Shift-JISでエンコードすると、いずれも「61」に変換しますが、平仮名の「あ」をエンコードすると、「3f（割当なし）」「E3 81 82」「82 A0」と別々の整数値が割当られます。
(整数値は16進数表記しています）

この表はXXX

| 文字 | ASCII | UTF-8             | Shift-JIS   | EUC-JP      |
| ---  | ---   | ---               | ---         | ---         |
| a    | 61    | 61                | 61          | 61          |
| あ   | 3f    | E3 81 82          | 82 A0       | A4 A2       |
| 世界 | 3f 3f | E4 B8 96 E7 95 8C | 90 A2 8A 45 | C0 A4 B3 A6 |
| 🐶   | 3f    | F0 9F 90 B6       | 3f          | 3f          |
| 🐱   | 3f    | F0 9F 90 B1       | 3f          | 3f          |


Perlのプログラムが外界（ファイル、ネットワーク、標準入出力など）と文字をやりとりする時、基本的にバイト列の形式になります。
同じ文字でも、ユーザーが利用する文字エンコーディング次第で、異なるバイト列になります。

---

WIP

### 内部文字列（Internal String）

内部文字列とは、Perl内部で文字として扱える形式の文字列です。Perlは内部的にUTF-8（厳密にはUTF-8の拡張であるUTF-8-MOD）でUnicode文字を表現しています。文字列操作（length、substr、正規表現など）を正しく行うには、バイト列を内部文字列に変換する必要があります。

```perl
use v5.42;
use utf8;

# バイト列のまま扱うと文字数が正しくない
my $bytes = "あいう";  # use utf8がないとバイト列
say length $bytes;  # 9（UTF-8のバイト数）

# 内部文字列として扱うと正しい文字数
use utf8;
my $chars = "あいう";  # use utf8があると内部文字列
say length $chars;  # 3（文字数）
```

### decode/encode

- **decode**: バイト列を内部文字列に変換する操作
- **encode**: 内部文字列をバイト列に変換する操作

```perl
use Encode qw(decode encode);

# decode: バイト列 → 内部文字列
my $internal = decode('UTF-8', $byte_string);

# encode: 内部文字列 → バイト列
my $bytes = encode('UTF-8', $internal_string);
```

## use utf8 プラグマ

`use utf8`プラグマは、内部文字列をUTF-8で扱うことをPerlに伝えます。

## よくある問題と解決策

### 問題1: Wide character in print警告

```perl
use v5.42;
use utf8;

my $text = "こんにちは";
print $text;  # Warning: Wide character in print
```

**解決策**: 出力時にencodeする

```perl
use Encode qw(encode_utf8);
print encode_utf8($text);

# または出力レイヤーを設定
binmode STDOUT, ':encoding(UTF-8)';
print $text;  # 警告なし
```

### 問題2: 文字化け

```perl
# Shift-JISファイルをUTF-8として読んでしまう
my $content = decode_utf8($shift_jis_bytes);  # 文字化け！
```

**解決策**: 正しいエンコーディングを指定

```perl
use Encode qw(decode);
my $content = decode('Shift_JIS', $shift_jis_bytes);
```

### 問題4: length関数が期待通りに動作しない

```perl
my $emoji = "👨‍👩‍👧‍👦";  # 家族の絵文字（結合文字）
say length $emoji;  # 7（期待は1）
```

**解決策**: 書記素クラスタとして扱う

```perl
use Unicode::GCString;
my $gcs = Unicode::GCString->new($emoji);
say $gcs->length;  # 1
```

## エンコーディングの判定

不明なエンコーディングのテキストを扱う場合：

```perl
use Encode::Guess;

sub guess_encoding($bytes) {
    my $decoder = Encode::Guess->guess($bytes);
    if (ref $decoder) {
        return $decoder->decode($bytes);
    } else {
        die "Cannot guess encoding: $decoder";
    }
}

# 特定のエンコーディングに限定して推測
Encode::Guess->add_suspects(qw/euc-jp shiftjis 7bit-jis/);
my $japanese_text = guess_encoding($unknown_bytes);
```

## ベストプラクティス

1. **常に`use utf8`を使用**: ソースコードにマルチバイト文字を含む場合
2. **境界で変換**: 入力時にdecode、出力時にencode
3. **内部処理は内部文字列で**: 文字列操作は必ず内部文字列で行う
4. **エンコーディングを明示**: ファイルやDBの接続時にエンコーディングを指定
5. **テストを書く**: マルチバイト文字を含むテストケースを用意

```perl
use Test2::V0;
use utf8;

# テストファイルもUTF-8で書く
is length("あいう"), 3, '日本語の文字数';
is "Hello, 世界" =~ s/世界/World/r, "Hello, World", '日本語の置換';

done_testing;
```

## SEE ALSO

- [Encode](https://metacpan.org/pod/Encode) - 文字エンコーディングの変換
- [perlunicode](https://perldoc.jp/docs/perl/perlunicode.pod) - PerlのUnicodeサポート
- [perlunitut](https://perldoc.jp/docs/perl/perlunitut.pod) - Unicodeチュートリアル
- [Unicode::GCString](https://metacpan.org/pod/Unicode::GCString) - 書記素クラスタの扱い
