---
title: "æ—¥æœ¬èªã‚„çµµæ–‡å­—ãªã©ã®ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã‚’æ‰±ã†ä½œæ³•"
---

`use v5.42`ã¨ã„ã¤ã‚‚ã®ãŠã¾ã˜ãªã„ã‚’æ›¸ã„ã¦ã€æ—¥æœ¬èªã‚„çµµæ–‡å­—ãªã©ã®ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å«ã‚ãŸå ´åˆã€ã€ŒUse of non-ASCII characterã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã¯`v5.41`ä»¥é™ã«å°å…¥ã•ã‚ŒãŸ[source::encoding](https://metacpan.org/pod/source::encoding)ãƒ—ãƒ©ã‚°ãƒã®å½±éŸ¿ã§ã€æ„å›³ã—ãªã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®æ··åœ¨ã€ã„ã‚ã‚†ã‚‹æ–‡å­—åŒ–ã‘ã‚’é˜²ããŸã‚ã®ã‚‚ã®ã§ã™ã€‚

```perl
use v5.42;

my ($message) = @ARGV;
$message //= 'Hello, ä¸–ç•Œ!'; # => Use of non-ASCII character 0xE4 illegal when 'use source::encoding "ascii"' is in effect

say $message;
```

ã“ã†ã„ã£ãŸãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã‚’æ‰±ã†æ™‚ã®ä½œæ³•ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

1. ãƒã‚¤ãƒˆåˆ—ã®å…¥åŠ›ã‚’decodeã—ã¦ãƒ†ã‚­ã‚¹ãƒˆæ–‡å­—åˆ—ã«ã™ã‚‹
2. ãƒ†ã‚­ã‚¹ãƒˆæ–‡å­—åˆ—ã‚’encodeã—ã¦ãƒã‚¤ãƒˆåˆ—ã‚’å‡ºåŠ›ã™ã‚‹

å®Ÿéš›ã«ã“ã®ä½œæ³•ã‚’ã‚³ãƒ¼ãƒ‰ã«åæ˜ ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚ã“ã“ã§ã¯ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

```perl
use v5.42;
use utf8;  # ãƒ†ã‚­ã‚¹ãƒˆæ–‡å­—åˆ—ã¯UTF-8ã«ã™ã‚‹ã¨å®£è¨€
use Encode qw(encode_utf8 decode_utf8);

my ($message) = map{ decode_utf8($_) } @ARGV;  # 1. å…¥åŠ›ã‚’decode
$message //= 'Hello, ä¸–ç•Œ!';

say encode_utf8($message);  # 2. å‡ºåŠ›ã‚’encode
```

## ç”¨èªã®æ•´ç†

### ãƒã‚¤ãƒˆåˆ—ï¼ˆByte Stringï¼‰

ãƒã‚¤ãƒˆåˆ—ã¨ã¯ã€æ–‡å­—ã‚’ç‰¹å®šã®è¦å‰‡ã«å¾“ã£ã¦æ•´æ•°å€¤ã«å¤‰æ›ã—ãŸã‚‚ã®ã§ã™ã€‚ã“ã®ç‰¹å®šã®è¦å‰‡ã‚’ã€æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨å‘¼ã³ã€ASCIIã€UTF-8ã€Shift-JISãªã©æ§˜ã€…ã‚ã‚Šã¾ã™ã€‚
ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ã€Œaã€ã‚’ã€ASCIIã€UTF-8ã€Shift-JISã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã„ãšã‚Œã‚‚ã€Œ61ã€ã«å¤‰æ›ã—ã¾ã™ãŒã€å¹³ä»®åã®ã€Œã‚ã€ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ã€Œ3fï¼ˆå‰²å½“ãªã—ï¼‰ã€ã€ŒE3 81 82ã€ã€Œ82 A0ã€ã¨åˆ¥ã€…ã®æ•´æ•°å€¤ãŒå‰²å½“ã‚‰ã‚Œã¾ã™ã€‚
(æ•´æ•°å€¤ã¯16é€²æ•°è¡¨è¨˜ã—ã¦ã„ã¾ã™ï¼‰

ã“ã®è¡¨ã¯XXX

| æ–‡å­— | ASCII | UTF-8             | Shift-JIS   | EUC-JP      |
| ---  | ---   | ---               | ---         | ---         |
| a    | 61    | 61                | 61          | 61          |
| ã‚   | 3f    | E3 81 82          | 82 A0       | A4 A2       |
| ä¸–ç•Œ | 3f 3f | E4 B8 96 E7 95 8C | 90 A2 8A 45 | C0 A4 B3 A6 |
| ğŸ¶   | 3f    | F0 9F 90 B6       | 3f          | 3f          |
| ğŸ±   | 3f    | F0 9F 90 B1       | 3f          | 3f          |


Perlã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå¤–ç•Œï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€æ¨™æº–å…¥å‡ºåŠ›ãªã©ï¼‰ã¨æ–‡å­—ã‚’ã‚„ã‚Šã¨ã‚Šã™ã‚‹æ™‚ã€åŸºæœ¬çš„ã«ãƒã‚¤ãƒˆåˆ—ã®å½¢å¼ã«ãªã‚Šã¾ã™ã€‚
åŒã˜æ–‡å­—ã§ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨ã™ã‚‹æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¬¡ç¬¬ã§ã€ç•°ãªã‚‹ãƒã‚¤ãƒˆåˆ—ã«ãªã‚Šã¾ã™ã€‚

---

WIP

### å†…éƒ¨æ–‡å­—åˆ—ï¼ˆInternal Stringï¼‰

å†…éƒ¨æ–‡å­—åˆ—ã¨ã¯ã€Perlå†…éƒ¨ã§æ–‡å­—ã¨ã—ã¦æ‰±ãˆã‚‹å½¢å¼ã®æ–‡å­—åˆ—ã§ã™ã€‚Perlã¯å†…éƒ¨çš„ã«UTF-8ï¼ˆå³å¯†ã«ã¯UTF-8ã®æ‹¡å¼µã§ã‚ã‚‹UTF-8-MODï¼‰ã§Unicodeæ–‡å­—ã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚æ–‡å­—åˆ—æ“ä½œï¼ˆlengthã€substrã€æ­£è¦è¡¨ç¾ãªã©ï¼‰ã‚’æ­£ã—ãè¡Œã†ã«ã¯ã€ãƒã‚¤ãƒˆåˆ—ã‚’å†…éƒ¨æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```perl
use v5.42;
use utf8;

# ãƒã‚¤ãƒˆåˆ—ã®ã¾ã¾æ‰±ã†ã¨æ–‡å­—æ•°ãŒæ­£ã—ããªã„
my $bytes = "ã‚ã„ã†";  # use utf8ãŒãªã„ã¨ãƒã‚¤ãƒˆåˆ—
say length $bytes;  # 9ï¼ˆUTF-8ã®ãƒã‚¤ãƒˆæ•°ï¼‰

# å†…éƒ¨æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ã¨æ­£ã—ã„æ–‡å­—æ•°
use utf8;
my $chars = "ã‚ã„ã†";  # use utf8ãŒã‚ã‚‹ã¨å†…éƒ¨æ–‡å­—åˆ—
say length $chars;  # 3ï¼ˆæ–‡å­—æ•°ï¼‰
```

### decode/encode

- **decode**: ãƒã‚¤ãƒˆåˆ—ã‚’å†…éƒ¨æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹æ“ä½œ
- **encode**: å†…éƒ¨æ–‡å­—åˆ—ã‚’ãƒã‚¤ãƒˆåˆ—ã«å¤‰æ›ã™ã‚‹æ“ä½œ

```perl
use Encode qw(decode encode);

# decode: ãƒã‚¤ãƒˆåˆ— â†’ å†…éƒ¨æ–‡å­—åˆ—
my $internal = decode('UTF-8', $byte_string);

# encode: å†…éƒ¨æ–‡å­—åˆ— â†’ ãƒã‚¤ãƒˆåˆ—
my $bytes = encode('UTF-8', $internal_string);
```

## use utf8 ãƒ—ãƒ©ã‚°ãƒ

`use utf8`ãƒ—ãƒ©ã‚°ãƒã¯ã€å†…éƒ¨æ–‡å­—åˆ—ã‚’UTF-8ã§æ‰±ã†ã“ã¨ã‚’Perlã«ä¼ãˆã¾ã™ã€‚

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

### å•é¡Œ1: Wide character in printè­¦å‘Š

```perl
use v5.42;
use utf8;

my $text = "ã“ã‚“ã«ã¡ã¯";
print $text;  # Warning: Wide character in print
```

**è§£æ±ºç­–**: å‡ºåŠ›æ™‚ã«encodeã™ã‚‹

```perl
use Encode qw(encode_utf8);
print encode_utf8($text);

# ã¾ãŸã¯å‡ºåŠ›ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨­å®š
binmode STDOUT, ':encoding(UTF-8)';
print $text;  # è­¦å‘Šãªã—
```

### å•é¡Œ2: æ–‡å­—åŒ–ã‘

```perl
# Shift-JISãƒ•ã‚¡ã‚¤ãƒ«ã‚’UTF-8ã¨ã—ã¦èª­ã‚“ã§ã—ã¾ã†
my $content = decode_utf8($shift_jis_bytes);  # æ–‡å­—åŒ–ã‘ï¼
```

**è§£æ±ºç­–**: æ­£ã—ã„ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æŒ‡å®š

```perl
use Encode qw(decode);
my $content = decode('Shift_JIS', $shift_jis_bytes);
```

### å•é¡Œ4: lengthé–¢æ•°ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã—ãªã„

```perl
my $emoji = "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦";  # å®¶æ—ã®çµµæ–‡å­—ï¼ˆçµåˆæ–‡å­—ï¼‰
say length $emoji;  # 7ï¼ˆæœŸå¾…ã¯1ï¼‰
```

**è§£æ±ºç­–**: æ›¸è¨˜ç´ ã‚¯ãƒ©ã‚¹ã‚¿ã¨ã—ã¦æ‰±ã†

```perl
use Unicode::GCString;
my $gcs = Unicode::GCString->new($emoji);
say $gcs->length;  # 1
```

## ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®åˆ¤å®š

ä¸æ˜ãªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰±ã†å ´åˆï¼š

```perl
use Encode::Guess;

sub guess_encoding($bytes) {
    my $decoder = Encode::Guess->guess($bytes);
    if (ref $decoder) {
        return $decoder->decode($bytes);
    } else {
        die "Cannot guess encoding: $decoder";
    }
}

# ç‰¹å®šã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«é™å®šã—ã¦æ¨æ¸¬
Encode::Guess->add_suspects(qw/euc-jp shiftjis 7bit-jis/);
my $japanese_text = guess_encoding($unknown_bytes);
```

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **å¸¸ã«`use utf8`ã‚’ä½¿ç”¨**: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã‚’å«ã‚€å ´åˆ
2. **å¢ƒç•Œã§å¤‰æ›**: å…¥åŠ›æ™‚ã«decodeã€å‡ºåŠ›æ™‚ã«encode
3. **å†…éƒ¨å‡¦ç†ã¯å†…éƒ¨æ–‡å­—åˆ—ã§**: æ–‡å­—åˆ—æ“ä½œã¯å¿…ãšå†…éƒ¨æ–‡å­—åˆ—ã§è¡Œã†
4. **ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ˜ç¤º**: ãƒ•ã‚¡ã‚¤ãƒ«ã‚„DBã®æ¥ç¶šæ™‚ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æŒ‡å®š
5. **ãƒ†ã‚¹ãƒˆã‚’æ›¸ã**: ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”¨æ„

```perl
use Test2::V0;
use utf8;

# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚UTF-8ã§æ›¸ã
is length("ã‚ã„ã†"), 3, 'æ—¥æœ¬èªã®æ–‡å­—æ•°';
is "Hello, ä¸–ç•Œ" =~ s/ä¸–ç•Œ/World/r, "Hello, World", 'æ—¥æœ¬èªã®ç½®æ›';

done_testing;
```

## SEE ALSO

- [Encode](https://metacpan.org/pod/Encode) - æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å¤‰æ›
- [perlunicode](https://perldoc.jp/docs/perl/perlunicode.pod) - Perlã®Unicodeã‚µãƒãƒ¼ãƒˆ
- [perlunitut](https://perldoc.jp/docs/perl/perlunitut.pod) - Unicodeãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
- [Unicode::GCString](https://metacpan.org/pod/Unicode::GCString) - æ›¸è¨˜ç´ ã‚¯ãƒ©ã‚¹ã‚¿ã®æ‰±ã„
